"use strict";(()=>{async function g(){try{let e=await fetch("/config.json",{cache:"no-store"});if(!e.ok)throw new Error(`Network response was not ok, status: ${e.status}`);let t=await e.json();if(!t.adminPasswordHash)throw new Error("Password hash not found in config file.");return t.adminPasswordHash}catch(e){return console.error("Failed to load admin configuration:",e),alert("Erreur critique: Impossible de charger la configuration de s\xE9curit\xE9. Veuillez contacter le support."),null}}function p(){localStorage.removeItem("adminPasswordHash"),window.location.href="admin-login.html"}var m="https://script.google.com/macros/s/AKfycbxEmJdgcerK1ENvsy8IvSnAZDJ6p4fr9hfO87haKbKrVXZaRf2Z3wnRzyQSDl527VtW/exec",i=[];async function y(){let e=document.getElementById("adminPassword").value.trim();if(!e){alert("Veuillez entrer un mot de passe.");return}let t=await g();if(!t)return;let n=await b(e);if(n!==t){alert("Mot de passe incorrect.");return}localStorage.setItem("adminPasswordHash",n),document.querySelector(".password-section").style.display="none",document.getElementById("adminContent").style.display="block",f()}async function b(e){let t=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(e));return Array.from(new Uint8Array(t)).map(n=>n.toString(16).padStart(2,"0")).join("")}async function f(){let e=document.getElementById("loadingIndicator"),t=document.getElementById("errorMessage"),n=document.getElementById("orderList");e.style.display="block",t.style.display="none",n.textContent="";try{let s=await fetch(m);if(!s.ok){let a=await s.json().catch(()=>({error:`Erreur HTTP: ${s.status}`}));throw new Error(a.error||`Erreur HTTP: ${s.status}`)}let o=await s.json();if(o.error)throw new Error(o.error);i=o,E(i),w(I(i))}catch(s){console.error("Erreur lors du chargement des commandes:",s),t.textContent="Erreur lors du chargement des commandes: "+s.message,t.style.display="block"}finally{e.style.display="none"}}async function D(e){let t=document.getElementById(`status-${e}`).value,n=document.getElementById(`notes-${e}`).value,s=document.getElementById(`message-${e}`);s.textContent="",s.className="";let o=localStorage.getItem("adminPasswordHash");if(!o){alert("Session expir\xE9e. Veuillez vous reconnecter."),p();return}let a=document.getElementById("loadingIndicator");a.style.display="block";try{let d=await(await fetch(m,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:o,action:"updateOrder",orderID:e,status:t,notes:n})})).json();if(d.success){s.textContent=d.message||"Commande mise \xE0 jour avec succ\xE8s!",s.className="success-message";let l=i.findIndex(c=>c.orderID===e);l>-1&&(i[l].status=t,i[l].notes=n),E(i)}else throw new Error(d.error||"Impossible de mettre \xE0 jour la commande.")}catch(r){s.textContent=`Erreur: ${r.message}`,s.className="error-message",console.error("Erreur lors de la mise \xE0 jour:",r)}finally{a.style.display="none",setTimeout(()=>{s.textContent="",s.className=""},5e3)}}async function B(e){let t=localStorage.getItem("adminPasswordHash");if(!t)return alert("Session expir\xE9e. Veuillez vous reconnecter.");alert("Tentative de renvoi de l'email...");let s=await(await fetch(m,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t,action:"resendEmail",orderID:e})})).json().catch(()=>({}));alert(s.message||"Email renvoy\xE9 (ou une erreur est survenue).")}async function H(e){let t=localStorage.getItem("adminPasswordHash");if(!t)return alert("Session expir\xE9e. Veuillez vous reconnecter.");if(!confirm(`\xCAtes-vous s\xFBr de vouloir supprimer la commande ${e} ? Cette action est irr\xE9versible.`))return;let s=await(await fetch(m,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t,action:"deleteOrder",orderID:e})})).json().catch(()=>({}));s.success?(i=i.filter(o=>o.orderID!==e),u()):alert(s.error||"Erreur lors de la suppression.")}function w(e){let t=document.getElementById("orderList");if(t.innerHTML="",e.length===0){t.innerHTML="<p>Aucune commande \xE0 afficher.</p>";return}e.forEach(n=>{let s=new Date(n.date),o=isNaN(s)?"Date invalide":s.toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),a=`
            <div class="order-item" data-order-id="${n.orderID}">
                <div class="order-header">
                    <h3>Commande: ${n.orderID}</h3>
                </div>
                <div class="order-details">
                    <p><strong>Email:</strong> ${n.email||"Non fourni"}</p>
                    <p><strong>Date:</strong> ${o}</p>
                    <div class="order-actions">
                        <label for="status-${n.orderID}">Statut:</label>
                        <select id="status-${n.orderID}" class="status-select">
                            ${["pending","processing","completed","cancelled","refunded"].map(r=>`<option value="${r}" ${n.status===r?"selected":""}>${r.charAt(0).toUpperCase()+r.slice(1)}</option>`).join("")}
                        </select>

                        <label for="notes-${n.orderID}">Notes:</label>
                        <textarea id="notes-${n.orderID}" class="notes-input" rows="3">${n.notes||""}</textarea>
                        
                        <div class="action-buttons">
                            <button class="save-btn update-btn" data-id="${n.orderID}">\u270F\uFE0F Sauvegarder</button>
                            <button class="save-btn resend-btn" data-id="${n.orderID}" title="Renvoyer l'email">\u{1F4E7}</button>
                            <button class="save-btn delete-btn" data-id="${n.orderID}" title="Supprimer">\u{1F5D1}\uFE0F</button>
                        </div>
                        <div id="message-${n.orderID}" class="message-area"></div>
                    </div>
                </div>
            </div>`;t.insertAdjacentHTML("beforeend",a)})}function E(e){let t=e.length,n=e.filter(c=>c.status==="pending").length,s=e.filter(c=>{let v=new Date(c.date),S=new Date;return v.toDateString()===S.toDateString()}).length,o=new Date,a=new Date(o.setDate(o.getDate()-o.getDay()+(o.getDay()===0?-6:1)));a.setHours(0,0,0,0);let r=e.filter(c=>new Date(c.date)>=a),d=r.filter(c=>c.status==="completed").length,l=r.length>0?Math.round(d/r.length*100):0;document.getElementById("stat-total").textContent=`Total: ${t}`,document.getElementById("stat-pending").textContent=`En attente: ${n}`,document.getElementById("stat-today").textContent=`Aujourd'hui: ${s}`,document.getElementById("stat-week").textContent=`Compl\xE9t\xE9 cette semaine: ${l}%`}function I(e){let t=document.getElementById("sortSelect").value;return[...e].sort((n,s)=>{let o=new Date(n.date),a=new Date(s.date);return t==="date-asc"?o-a:a-o})}function u(){let e=document.getElementById("searchBox").value.toLowerCase(),t=document.getElementById("statusFilter").value;if(!i)return;let n=i.filter(o=>{let a=!e||o.orderID&&String(o.orderID).toLowerCase().includes(e)||o.email&&o.email.toLowerCase().includes(e),r=t==="all"||o.status===t;return a&&r}),s=I(n);w(s)}function $(){if(!i.length)return;let e=["orderID","email","date","status","notes"],t=i.map(a=>e.map(r=>`"${(a[r]||"").toString().replace(/"/g,'""')}"`).join(",")).join(`
`),n=`${e.join(",")}
${t}`,s=new Blob([n],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a");o.href=URL.createObjectURL(s),o.download=`spotideals_orders_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(o),o.click(),document.body.removeChild(o)}function h(){document.getElementById("statusFilter").addEventListener("change",u),document.getElementById("sortSelect").addEventListener("change",u),document.getElementById("searchBox").addEventListener("input",u),document.getElementById("exportCsvBtn").addEventListener("click",$),document.getElementById("printBtn").addEventListener("click",()=>window.print()),document.getElementById("logoutBtn").addEventListener("click",p);let e=document.querySelector(".password-section button");e&&e.addEventListener("click",y),document.getElementById("adminPassword").addEventListener("keypress",t=>{t.key==="Enter"&&y()}),document.getElementById("orderList").addEventListener("click",t=>{let n=t.target.closest("button");if(!n)return;let s=n.dataset.id;n.classList.contains("update-btn")?D(s):n.classList.contains("resend-btn")?B(s):n.classList.contains("delete-btn")&&H(s)})}async function x(){let e=localStorage.getItem("adminPasswordHash"),t=await g();t&&(e===t?(document.querySelector(".password-section").style.display="none",document.getElementById("adminContent").style.display="block",h(),f()):(document.querySelector(".password-section").style.display="block",document.getElementById("adminContent").style.display="none",h()))}document.addEventListener("DOMContentLoaded",x);})();
